# 企业体量驱动的流量分发模型

## 概述

新的数据生成逻辑采用**企业体量驱动模型**，从企业规模出发，自动计算流量和订单：

```
企业体量 → 流量基数 → 流量分发 → 曝光/点击 → 转化 → 订单生成 → 销售日报
```

**核心理念**: 前端只需选择企业体量和时间跨度，系统自动计算流量、转化和订单数

## 企业体量配置

### 体量分级

| 体量 | 店铺数 | 月GMV | 日均流量/店 | 说明 |
|------|--------|-------|-------------|------|
| 微型企业 | 1-2家 | 10-50万 | 250 | 个人创业 |
| 小型企业 | 3-5家 | 50-200万 | 1,500 | 小团队 |
| 中型企业 | 6-10家 | 200-1000万 | 6,000 | 成熟企业 |
| 大型企业 | 10-20家 | 1000-5000万 | 40,000 | 集团公司 |
| 超大型企业 | 20+家 | 5000万+ | 200,000 | 上市公司 |

### 自动计算逻辑

1. **流量计算**: 总流量 = 店铺数 × 每店日均流量 × 天数
2. **点击计算**: 总点击 = 总曝光 × 点击率(3%)
3. **订单计算**: 总订单 = 总点击 × 转化率(5%)
4. **GMV计算**: 总GMV = 总订单 × 客单价(500元)

## 核心模块

### 1. BusinessScale（企业体量配置）

**位置**: `scripts/business_scale.py`

**功能**: 定义企业体量和流量基数

**主要方法**:
- `get_scale_config()`: 获取体量配置
- `calculate_traffic_from_scale()`: 计算流量
- `get_scale_summary()`: 获取体量摘要

### 2. TrafficDistributor（流量分发器）

**位置**: `scripts/traffic_distribution.py`

**功能**: 根据商品分层为所有商品分配流量权重

**商品分层流量权重**:
- 畅销品: 3.0倍（高流量）
- 利润品: 0.5倍（低流量）
- 主推新品: 1.5倍（中等流量，推广加持）
- 滞销品: 0.3倍（极低流量）
- 引流品: 4.0倍（最高流量）

**流量类型**:
- **自然流量**: 搜索、推荐、直接访问、活动页、店铺首页
- **付费流量**: 各平台推广渠道（直通车、京东快车、巨量千川等）

**分配规则**:
- 每个商品每天都会获得自然流量
- 主推新品和引流品会额外获得付费流量
- 其他商品有30%概率获得付费流量

### 2. ConversionEngine（转化引擎）

**位置**: `scripts/conversion_engine.py`

**功能**: 将流量数据转化为订单

**商品分层转化率**:
- 畅销品: 3-8%
- 利润品: 1-3%
- 主推新品: 2-5%
- 滞销品: 0.5-1.5%
- 引流品: 4-10%

**转化逻辑**:
1. 按日期聚合流量数据
2. 计算每个商品的转化数 = 点击量 × 转化率
3. 根据转化数生成订单
4. 订单自动关联流量来源（付费推广/自然流量）

## 数据流转

### 第一步：流量分发

```python
from traffic_distribution import TrafficDistributor

distributor = TrafficDistributor(products_df, time_span_days=365)
traffic_df = distributor.distribute_traffic()
```

**输出**: 流量表（包含曝光、点击、流量来源、推广费用等）

### 第二步：流量转化

```python
from conversion_engine import ConversionEngine

engine = ConversionEngine(traffic_df, products_df, users_df, stores_df)
orders_df, order_details_df = engine.generate_orders_from_traffic(target_order_count=50000)
```

**输出**: 订单表 + 订单明细表（自动关联流量来源）

### 第三步：数据拆分

流量数据拆分为：
- **ods_promotion**: 付费推广表
- **ods_product_traffic**: 商品自然流量表

## 数据一致性保证

1. **流量→订单关联**: 每个订单都有明确的流量来源
2. **转化率真实**: 根据商品分层设置合理的转化率
3. **推广费用合理**: 付费流量自动计算CPC和推广费用
4. **时间一致**: 流量和订单在同一天生成

## 使用方法

### 生成数据

```bash
python scripts/generate_data.py
```

配置参数（JSON格式）:
```json
{
  "businessScale": "中型企业",
  "timeSpanDays": 365,
  "mainCategory": "bicycle",
  "platformStores": {...}
}
```

**参数说明**:
- `businessScale`: 企业体量（微型/小型/中型/大型/超大型企业）
- `timeSpanDays`: 时间跨度（天）
- `mainCategory`: 主营类目
- `platformStores`: 平台店铺配置

**不再需要的参数**:
- ~~`numOrders`~~: 订单数由流量自动计算

### 测试流量模型

```bash
python scripts/test_traffic_flow.py
```

## 优势

1. **真实性**: 流量→转化→订单的完整链路
2. **一致性**: 数据之间有明确的因果关系
3. **可控性**: 通过商品分层控制流量和转化
4. **灵活性**: 可以调整各分层的权重和转化率

## 与旧模型对比

| 特性 | 旧模型 | 新模型 |
|------|--------|--------|
| 输入参数 | 订单数 | 企业体量 |
| 订单生成 | 随机生成 | 从流量转化生成 |
| 流量来源 | 事后标记 | 实时关联 |
| 数据一致性 | 弱 | 强 |
| 转化率 | 不可控 | 可控 |
| 推广效果 | 无法追踪 | 可追踪ROI |
| 业务真实性 | 低 | 高（符合企业规模） |

## 前端配置建议

### 简化配置界面

**必填项**:
1. 企业体量（下拉选择）
2. 时间跨度（天数）
3. 主营类目（下拉选择）

**可选项**:
- 平台店铺配置（高级选项）

**移除项**:
- ~~订单数量~~（自动计算）
- ~~用户数量~~（自动计算）

### 配置示例

```javascript
{
  businessScale: "中型企业",  // 企业体量
  timeSpanDays: 365,          // 1年数据
  mainCategory: "bicycle",    // 自行车类目
  platformStores: {
    "京东": {"品牌": ["旗舰店"], "白牌": ["专营店1号", "专营店2号"]},
    "天猫": {"品牌": ["旗舰店"], "白牌": ["专营店1号"]}
  }
}
```

### 预览信息

配置完成后，前端可显示预估信息：
- 预估总流量
- 预估订单数
- 预估月GMV
- 预估用户数
